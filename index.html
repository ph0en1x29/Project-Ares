<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Project Ares ‚Äî Entry Signal Engine</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;600;700;800&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg-0:#06080C;--bg-1:#0C0E14;--bg-2:#11141B;--bg-3:#181C26;
  --border:#1C2030;--border-h:#252A3A;
  --text-0:#E8ECF4;--text-1:#A0A8BA;--text-2:#5A6278;--text-3:#3A4058;
  --blue:#3B82F6;--purple:#8B5CF6;--amber:#F59E0B;--red:#EF4444;--green:#10B981;
  --green-bright:#00E676;--red-bright:#FF5252;--orange:#FF9800;--cyan:#06B6D4;
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg-0);color:var(--text-0);font-family:'DM Sans',system-ui,sans-serif;min-height:100vh;padding:16px 20px;-webkit-font-smoothing:antialiased}
.mono{font-family:'JetBrains Mono',monospace}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
@keyframes slideIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
.slide-in{animation:slideIn .3s ease both}
.live-num{transition:color .4s ease;display:inline-block}
.live-num.tick-up{color:var(--green-bright)!important}
.live-num.tick-dn{color:var(--red-bright)!important}
.dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;display:inline-block}
.dot.live{background:var(--green-bright);animation:pulse 2s infinite}
.dot.ws{background:var(--blue);animation:pulse 1.5s infinite}
.dot.off{background:var(--red-bright)}
.up{color:var(--green-bright)}.dn{color:var(--red-bright)}

/* Header */
.header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px;flex-wrap:wrap;gap:12px}
.header-left h1{font-size:22px;font-weight:800;line-height:1;letter-spacing:-.5px}
.status-row{display:flex;align-items:center;gap:8px;margin-top:5px;font-size:10px;color:var(--text-2)}

/* Tabs */
.tab-bar{display:flex;gap:2px;margin-bottom:14px;background:var(--bg-2);border-radius:10px;padding:3px;border:1px solid var(--border)}
.tab-btn{flex:1;padding:10px 16px;border:none;background:transparent;color:var(--text-2);font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:600;letter-spacing:.5px;cursor:pointer;border-radius:8px;transition:all .2s}
.tab-btn:hover{color:var(--text-1);background:var(--bg-3)}
.tab-btn.active{background:var(--blue);color:white}
.tab-content{display:none}.tab-content.active{display:block}

/* Search */
.search-container{position:relative;margin-bottom:14px}
.search-row{display:flex;gap:8px}
.search-input{flex:1;background:var(--bg-2);border:1px solid var(--border);border-radius:10px;padding:12px 16px 12px 40px;color:var(--text-0);font-family:'DM Sans',sans-serif;font-size:14px;outline:none;transition:border-color .2s}
.search-input:focus{border-color:var(--blue)}
.search-input::placeholder{color:var(--text-3)}
.search-icon{position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--text-3);font-size:16px;pointer-events:none;z-index:1}
.search-results{position:absolute;top:100%;left:0;right:0;background:var(--bg-2);border:1px solid var(--border);border-radius:10px;margin-top:4px;max-height:300px;overflow-y:auto;z-index:100;display:none}
.search-results.show{display:block}
.search-item{padding:10px 16px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--border);transition:background .15s}
.search-item:hover{background:var(--bg-3)}
.search-item:last-child{border-bottom:none}
.search-item .sym{font-weight:700;font-size:14px}
.search-item .desc{font-size:11px;color:var(--text-2);max-width:60%}
.search-item .type{font-size:9px;color:var(--text-3);background:var(--bg-3);padding:2px 6px;border-radius:3px}

/* Market bar */
.market-row{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap}
.market-chip{background:var(--bg-2);border:1px solid var(--border);border-radius:8px;padding:8px 14px;flex:1;min-width:100px}
.market-chip .lbl{font-size:8px;color:var(--text-3);letter-spacing:1.5px}
.market-chip .val{font-size:17px;font-weight:700;margin-top:1px}
.market-chip .chg{font-size:10px;margin-top:1px}

/* Weights */
.weights-panel{background:var(--bg-2);border:1px solid var(--border);border-radius:10px;padding:10px 14px;margin-bottom:12px}
.weights-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:14px}
.weight-item label{display:flex;justify-content:space-between;font-size:9px;margin-bottom:3px}
input[type="range"]{-webkit-appearance:none;width:100%;height:3px;background:var(--bg-3);border-radius:2px;outline:none;cursor:pointer}
input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;width:12px;height:12px;background:var(--blue);border-radius:50%;cursor:pointer;border:2px solid var(--bg-0)}

/* Cards */
.cards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:10px;margin-bottom:14px}
.ticker-card{background:var(--bg-2);border:1px solid var(--border);border-radius:10px;padding:14px;cursor:pointer;transition:border-color .2s,transform .2s;position:relative;overflow:hidden}
.ticker-card:hover{border-color:var(--border-h);transform:translateY(-1px)}
.ticker-card.selected{background:var(--bg-3)}
.ticker-card .accent{position:absolute;top:0;left:0;right:0;height:2px}
.ticker-card .top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px}
.ticker-card .sym{font-size:15px;font-weight:700;letter-spacing:.5px}
.ticker-card .nm{font-size:9px;color:var(--text-3)}
.signal-badge{padding:2px 7px;border-radius:4px;font-size:8px;font-weight:700;letter-spacing:.5px}
.ticker-card .price-row{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:8px}
.ticker-card .price{font-size:20px;font-weight:700}
.ticker-card .day-chg{font-size:11px;font-weight:600}
.ticker-card .meta-row{display:flex;gap:6px;font-size:8px;color:var(--text-3);margin-bottom:8px;flex-wrap:wrap}
.score-bar{margin-bottom:3px}
.score-bar .bar-hdr{display:flex;justify-content:space-between;font-size:8px;color:var(--text-2);margin-bottom:1px}
.score-bar .bar-hdr .bv{color:var(--text-1);font-weight:600}
.bar-track{background:var(--bg-3);border-radius:3px;height:4px;overflow:hidden}
.bar-fill{height:100%;border-radius:3px;transition:width .8s cubic-bezier(.4,0,.2,1)}
.composite-row{margin-top:8px;padding-top:8px;border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.composite-row .cl{font-size:8px;color:var(--text-3)}
.composite-row .cv{font-size:20px;font-weight:800;transition:color .4s}
.card-actions{display:flex;gap:6px;margin-top:8px;padding-top:8px;border-top:1px solid var(--border)}

/* Detail panel */
.detail-panel{background:var(--bg-2);border:1px solid var(--border);border-radius:10px;padding:18px;margin-bottom:14px}
.detail-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;flex-wrap:wrap;gap:8px}
.detail-title{display:flex;align-items:center;gap:10px}
.detail-title .bar{width:3px;height:26px;border-radius:2px}
.detail-title h2{font-size:16px;font-weight:700}
.detail-title .sub{font-size:10px;color:var(--text-2);margin-top:1px}
.detail-signal{padding:5px 12px;border-radius:6px;font-size:12px;font-weight:700}
.metrics-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:5px;margin-bottom:14px}
.metric-box{background:var(--bg-1);border-radius:6px;padding:6px 10px;border:1px solid #141824}
.metric-box .ml{font-size:7px;color:var(--text-3);text-transform:uppercase;letter-spacing:.8px}
.metric-box .mv{font-size:11px;font-weight:600;margin-top:1px;color:var(--text-1);transition:color .3s}
.metric-box .mv.warn{color:var(--amber)}
.detail-cols{display:grid;grid-template-columns:1fr 1fr;gap:16px}
@media(max-width:700px){.detail-cols{grid-template-columns:1fr}.weights-grid{grid-template-columns:repeat(2,1fr)}}
.section-title{font-size:9px;color:var(--text-3);letter-spacing:1px;margin-bottom:8px}
.factors{font-size:11px;color:var(--text-2);line-height:1.8}

/* Buttons */
.btn{background:var(--blue);color:white;border:none;border-radius:6px;padding:8px 16px;font-weight:600;cursor:pointer;font-size:12px;font-family:'DM Sans',sans-serif;transition:opacity .2s}
.btn:hover{opacity:.85}
.btn:disabled{opacity:.4;cursor:not-allowed}
.btn-sm{padding:4px 10px;font-size:10px;border-radius:4px}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--text-1)}
.btn-outline:hover{border-color:var(--text-2)}
.btn-green{background:var(--green)}
.btn-red{background:var(--red)}
.btn-purple{background:var(--purple)}
.btn-amber{background:var(--amber);color:var(--bg-0)}

/* Paper Trading */
.portfolio-summary{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;margin-bottom:14px}
.port-card{background:var(--bg-2);border:1px solid var(--border);border-radius:10px;padding:14px}
.port-card .port-lbl{font-size:8px;color:var(--text-3);letter-spacing:1.5px;margin-bottom:4px}
.port-card .port-val{font-size:22px;font-weight:800}
.port-card .port-sub{font-size:10px;margin-top:2px}

.positions-table{width:100%;border-collapse:collapse;margin-bottom:14px}
.positions-table th{font-size:9px;color:var(--text-3);letter-spacing:1px;text-align:left;padding:8px 10px;border-bottom:1px solid var(--border)}
.positions-table td{font-size:12px;padding:8px 10px;border-bottom:1px solid var(--border)}
.positions-table tr:hover{background:var(--bg-3)}

.trade-form{background:var(--bg-2);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:14px}
.trade-form h3{font-size:13px;margin-bottom:12px}
.form-row{display:flex;gap:8px;margin-bottom:8px;align-items:center;flex-wrap:wrap}
.form-input{background:var(--bg-1);border:1px solid var(--border);border-radius:6px;padding:8px 12px;color:var(--text-0);font-family:'JetBrains Mono',monospace;font-size:12px;outline:none;width:140px}
.form-input:focus{border-color:var(--blue)}
.form-label{font-size:10px;color:var(--text-2);min-width:50px}

/* Performance */
.perf-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;margin-bottom:14px}
.perf-card{background:var(--bg-2);border:1px solid var(--border);border-radius:10px;padding:16px;text-align:center}
.perf-card .perf-val{font-size:28px;font-weight:800;margin:6px 0}
.perf-card .perf-lbl{font-size:9px;color:var(--text-3);letter-spacing:1px}
.chart-container{background:var(--bg-2);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:14px}
.chart-container h3{font-size:12px;color:var(--text-2);margin-bottom:12px}

/* Footer */
.footer{background:var(--bg-2);border:1px solid var(--border);border-radius:10px;padding:14px;font-size:10px;color:var(--text-3);line-height:1.8}
.footer strong{color:var(--text-2)}
.footer .warn{color:#FF980055;font-size:9px;margin-top:6px}

/* Remove card btn */
.remove-btn{position:absolute;top:8px;right:8px;background:none;border:none;color:var(--text-3);cursor:pointer;font-size:14px;opacity:0;transition:opacity .2s}
.ticker-card:hover .remove-btn{opacity:1}
.remove-btn:hover{color:var(--red)}

/* Toast */
.toast{position:fixed;bottom:20px;right:20px;background:var(--bg-3);border:1px solid var(--border);border-radius:8px;padding:10px 16px;font-size:12px;color:var(--text-0);z-index:1000;animation:slideIn .3s ease;transition:opacity .3s}
.toast.success{border-color:var(--green)}
.toast.error{border-color:var(--red)}

/* Loading spinner */
.spinner{display:inline-block;width:14px;height:14px;border:2px solid var(--text-3);border-top-color:var(--blue);border-radius:50%;animation:spin .6s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* Scrollbar */
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:var(--bg-3);border-radius:2px}
</style>
</head>
<body>
<div id="app"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONFIG & STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const POLL_MS = 60000;
const SNAPSHOT_MS = 900000; // 15 min

let CFG = { fk:'', sbUrl:'', sbKey:'' };
let sb = null; // Supabase client

let S = {
  tickers: [], // dynamic list
  tickerData: {}, // {AAPL: {name, color, metrics, quote, options, profile, ...}}
  wsConnected: false,
  prices: {},
  prevSnapshot: {},
  market: { vix:0, vixPrev:0, sp500:0, sp500Prev:0, ndx:0, ndxPrev:0, fearGreed:35 },
  selected: null,
  weights: JSON.parse(localStorage.getItem('signal_weights') || '{"technical":30,"value":25,"catalyst":25,"volatility":20}'),
  lastPoll: null, wsLast: null, refreshCount: 0, countdown: 60,
  activeTab: 'signals',
  // Paper trading
  portfolio: { cash: 10000, startValue: 10000 },
  positions: [], // [{symbol, shares, avgCost, entryDate}]
  tradeHistory: [], // [{symbol, type, shares, price, date, pnl}]
  portfolioHistory: [], // [{date, value}]
};

let ws = null;
let searchTimeout = null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SUPABASE CLIENT (minimal)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
class SupabaseClient {
  constructor(url, key) { this.url = url; this.key = key; }
  async query(table, method='GET', body=null, params='') {
    const opts = { method, headers: { 'apikey':this.key, 'Authorization':`Bearer ${this.key}`, 'Content-Type':'application/json', 'Prefer': method==='POST'?'return=representation':'' } };
    if(body) opts.body = JSON.stringify(body);
    try {
      const r = await fetch(`${this.url}/rest/v1/${table}${params?'?'+params:''}`, opts);
      if(!r.ok) { console.error('Supabase error', r.status, await r.text()); return null; }
      return await r.json();
    } catch(e) { console.error('Supabase fetch error', e); return null; }
  }
  select(table, params='') { return this.query(table, 'GET', null, params); }
  insert(table, data) { return this.query(table, 'POST', Array.isArray(data)?data:[data]); }
  async upsert(table, data) {
    const opts = { method:'POST', headers: { 'apikey':this.key, 'Authorization':`Bearer ${this.key}`, 'Content-Type':'application/json', 'Prefer':'return=representation,resolution=merge-duplicates' } };
    opts.body = JSON.stringify(Array.isArray(data)?data:[data]);
    try {
      const r = await fetch(`${this.url}/rest/v1/${table}`, opts);
      return r.ok ? await r.json() : null;
    } catch(e) { return null; }
  }
  async delete(table, params) {
    return this.query(table, 'DELETE', null, params);
  }
  async update(table, data, params) {
    const opts = { method:'PATCH', headers: { 'apikey':this.key, 'Authorization':`Bearer ${this.key}`, 'Content-Type':'application/json', 'Prefer':'return=representation' } };
    opts.body = JSON.stringify(data);
    try {
      const r = await fetch(`${this.url}/rest/v1/${table}?${params}`, opts);
      return r.ok ? await r.json() : null;
    } catch(e) { return null; }
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SCORING ENGINE ‚Äî fully dynamic, no hardcoded data
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function techScore(td) {
  if(!td.quote) return {score:0, rsi:50};
  const price = td.quote.c;
  const m = td.metrics || {};
  const high52 = m['52WeekHigh'] || price;
  const low52 = m['52WeekLow'] || price;
  const range = high52 - low52;
  const beta = m['beta'] || 1;

  let s = 0;
  // Price position in 52w range (lower = better for entry)
  if(range > 0) {
    const pos = (price - low52) / range; // 0=at low, 1=at high
    if(pos < 0.2) s += 35;
    else if(pos < 0.35) s += 28;
    else if(pos < 0.5) s += 18;
    else if(pos < 0.7) s += 8;
    else s += 2;
  }
  // Drawdown from 52w high
  const dd = high52 > 0 ? ((high52 - price) / high52 * 100) : 0;
  if(dd > 30) s += 30; else if(dd > 20) s += 24; else if(dd > 15) s += 18; else if(dd > 10) s += 12; else if(dd > 5) s += 5;
  // Beta bonus (higher beta = more volatile = better entry when down)
  if(beta > 1.5) s += 15; else if(beta > 1.2) s += 10; else if(beta > 1) s += 5; else s += 2;
  // SMA proxy from 52w data
  const midRange = (high52 + low52) / 2;
  if(price < midRange * 0.9) s += 20; else if(price < midRange) s += 12; else s += 3;

  const rsiEst = range > 0 ? 30 + ((price - low52) / range) * 40 : 50;
  return { score: Math.min(s, 100), rsi: Math.round(rsiEst * 10) / 10 };
}

function valScore(td) {
  if(!td.quote) return 0;
  const price = td.quote.c;
  const m = td.metrics || {};
  const pt = td.priceTarget || {};
  const rec = td.recommendation || [];

  let s = 0;
  // P/E
  const pe = m['peNormalizedAnnual'] || m['peBasicExclExtraTTM'] || 0;
  if(pe > 0 && pe < 15) s += 25; else if(pe < 25) s += 18; else if(pe < 35) s += 10; else if(pe < 50) s += 5;
  // PEG
  const peg = m['pegRatio'] || m['peg'] || 0;
  if(peg > 0 && peg < 0.5) s += 30; else if(peg < 1) s += 25; else if(peg < 1.5) s += 15; else if(peg < 2) s += 8; else if(peg > 0) s += 3;
  // Analyst target upside
  const target = pt.targetMean || pt.targetMedian || 0;
  if(target > 0 && price > 0) {
    const upside = ((target - price) / price) * 100;
    if(upside > 50) s += 25; else if(upside > 30) s += 20; else if(upside > 20) s += 15; else if(upside > 10) s += 8; else s += 2;
  }
  // Buy/sell ratio from latest recommendation
  if(rec.length > 0) {
    const latest = rec[0];
    const buys = (latest.buy || 0) + (latest.strongBuy || 0);
    const sells = (latest.sell || 0) + (latest.strongSell || 0);
    const total = buys + sells + (latest.hold || 0);
    if(total > 0) s += Math.round((buys / total) * 20);
  }
  return Math.min(s, 100);
}

function catScore(td) {
  const earnings = td.earnings || {};
  let s = 0, dte = 999;

  if(earnings.earningsDate) {
    dte = Math.round((new Date(earnings.earningsDate) - new Date()) / 864e5);
    if(dte >= 10 && dte <= 25) s += 40;
    else if(dte >= 5 && dte < 10) s += 25;
    else if(dte >= 25 && dte <= 40) s += 20;
    else if(dte > 40) s += 10;
    else s += 5;
  } else {
    s += 10; // Unknown earnings
  }
  // Analyst consensus strength
  const rec = td.recommendation || [];
  if(rec.length > 0) {
    const latest = rec[0];
    const buys = (latest.buy || 0) + (latest.strongBuy || 0);
    const total = buys + (latest.sell || 0) + (latest.strongSell || 0) + (latest.hold || 0);
    s += total > 0 ? Math.round((buys / total) * 35) : 10;
  }
  // Profile-based importance (large cap = more important catalyst)
  if(td.profile?.marketCapitalization) {
    const mc = td.profile.marketCapitalization; // in millions
    if(mc > 500000) s += 25; else if(mc > 100000) s += 18; else if(mc > 10000) s += 12; else s += 5;
  }
  return { score: Math.min(s, 100), dte };
}

function volScore(td) {
  let s = 0;
  const vix = S.market.vix;
  const vixPrev = S.market.vixPrev;
  const fg = S.market.fearGreed;
  const beta = td.metrics?.['beta'] || 1;
  const pcRatio = td.options?.pcRatio || null;

  if(vix > 30) s += 30; else if(vix > 25) s += 25; else if(vix > 20) s += 18; else if(vix > 18) s += 12; else if(vix > 15) s += 6;
  if(vixPrev && vix > vixPrev) s += 10;
  if(fg < 20) s += 25; else if(fg < 30) s += 20; else if(fg < 40) s += 12; else if(fg < 50) s += 5;
  if(pcRatio != null) {
    if(pcRatio > 1.5) s += 20; else if(pcRatio > 1.2) s += 15; else if(pcRatio > 1) s += 10; else if(pcRatio > 0.8) s += 5;
  }
  if(beta > 1.5) s += 15; else if(beta > 1.2) s += 10; else if(beta > 1) s += 5;
  return Math.min(s, 100);
}

function calcAll(ticker) {
  const td = S.tickerData[ticker];
  if(!td?.quote?.c) return null;
  const t = techScore(td), v = valScore(td), c = catScore(td), vol = volScore(td);
  const w = S.weights;
  const comp = (t.score * w.technical + v * w.value + c.score * w.catalyst + vol * w.volatility) / 100;
  return { tech:t.score, rsi:t.rsi, val:v, cat:c.score, dte:c.dte, vol, comp };
}

function sig(comp) {
  if(comp >= 75) return {label:'STRONG BUY',color:'#00E676',bg:'#00E67612'};
  if(comp >= 60) return {label:'BUY',color:'#4CAF50',bg:'#4CAF5012'};
  if(comp >= 45) return {label:'ACCUMULATE',color:'#FFC107',bg:'#FFC10712'};
  if(comp >= 30) return {label:'WAIT',color:'#FF9800',bg:'#FF980012'};
  return {label:'AVOID',color:'#F44336',bg:'#F4433612'};
}

// Color generator for tickers
function tickerColor(sym) {
  let h = 0; for(let i = 0; i < sym.length; i++) h = sym.charCodeAt(i) + ((h << 5) - h);
  return `hsl(${Math.abs(h) % 360}, 70%, 55%)`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DATA FETCHING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function fhGet(endpoint) {
  const key = CFG.fk || S.apiKey || localStorage.getItem('finnhub_key') || '';
  if(!key) return null;
  try {
    const r = await fetch(`https://finnhub.io/api/v1${endpoint}${endpoint.includes('?')?'&':'?'}token=${key}`, {signal:AbortSignal.timeout(8000)});
    if(!r.ok) return null;
    return await r.json();
  } catch(e) { return null; }
}

async function searchTickers(q) {
  const d = await fhGet(`/search?q=${encodeURIComponent(q)}`);
  return d?.result?.filter(r => r.type === 'Common Stock' || r.type === 'ETP') || [];
}

async function fetchTickerData(ticker) {
  if(!S.tickerData[ticker]) S.tickerData[ticker] = { symbol: ticker };
  const td = S.tickerData[ticker];

  const [quote, profile, metrics, target, rec, earningsData] = await Promise.all([
    fhGet(`/quote?symbol=${ticker}`),
    fhGet(`/stock/profile2?symbol=${ticker}`),
    fhGet(`/stock/metric?symbol=${ticker}&metric=all`),
    fhGet(`/stock/price-target?symbol=${ticker}`),
    fhGet(`/stock/recommendation?symbol=${ticker}`),
    fhGet(`/calendar/earnings?symbol=${ticker}`)
  ]);

  if(quote?.c) {
    td.quote = quote;
    S.prices[ticker] = { price: quote.c, prevClose: quote.pc, high: quote.h, low: quote.l, open: quote.o, source: 'finnhub-rest' };
  }
  if(profile?.name) { td.profile = profile; td.name = profile.name; td.color = tickerColor(ticker); }
  if(metrics?.metric) td.metrics = metrics.metric;
  if(target) td.priceTarget = target;
  if(rec) td.recommendation = rec;
  if(earningsData?.earningsCalendar?.length) {
    const future = earningsData.earningsCalendar.find(e => new Date(e.date) > new Date());
    td.earnings = future ? { earningsDate: future.date } : {};
  }

  // Fetch options for P/C ratio (don't await ‚Äî it's slow)
  fetchOptionsForTicker(ticker);
  return td;
}

async function fetchOptionsForTicker(ticker) {
  const td = S.tickerData[ticker];
  if(!td) return;
  try {
    const d = await fhGet(`/stock/option-chain?symbol=${ticker}`);
    if(d?.data?.length) {
      const nearest = d.data[0];
      const calls = nearest.options?.CALL || [];
      const puts = nearest.options?.PUT || [];
      const callOI = calls.reduce((a,o) => a + (o.openInterest||0), 0);
      const putOI = puts.reduce((a,o) => a + (o.openInterest||0), 0);
      td.options = {
        pcRatio: callOI > 0 ? putOI / callOI : null,
        callOI, putOI,
        callVol: calls.reduce((a,o) => a + (o.volume||0), 0),
        putVol: puts.reduce((a,o) => a + (o.volume||0), 0)
      };
      updateUI();
    }
  } catch(e) {}
}

async function pollAllQuotes() {
  for(const t of S.tickers) {
    if(S.prices[t]?.price) S.prevSnapshot[t] = S.prices[t].price;
  }
  const syms = [...S.tickers, 'SPY', 'QQQ', 'VIXY'];
  const results = await Promise.all(syms.map(sym => fhGet(`/quote?symbol=${sym}`).then(d => d ? {sym,...d} : null)));
  for(const q of results) {
    if(!q?.c) continue;
    if(S.tickers.includes(q.sym)) {
      const td = S.tickerData[q.sym];
      if(td) td.quote = q;
      S.prices[q.sym] = { price:q.c, prevClose:q.pc, high:q.h, low:q.l, open:q.o, source:'finnhub-rest' };
    }
    if(q.sym==='VIXY') { S.market.vix=q.c; S.market.vixPrev=q.pc; }
    if(q.sym==='SPY') { S.market.sp500=q.c; S.market.sp500Prev=q.pc; }
    if(q.sym==='QQQ') { S.market.ndx=q.c; S.market.ndxPrev=q.pc; }
  }
  S.lastPoll = new Date();
  S.refreshCount++;
  S.countdown = 60;
  updateUI();
}

async function fetchFearGreed() {
  try {
    const r = await fetch('https://api.alternative.me/fng/?limit=1', {signal:AbortSignal.timeout(5000)});
    const d = await r.json();
    if(d?.data?.[0]) S.market.fearGreed = parseInt(d.data[0].value);
  } catch(e) {}
}

// WebSocket
function connectWS() {
  const key = CFG.fk || localStorage.getItem('finnhub_key');
  if(!key) return;
  if(ws) { ws.close(); ws=null; }
  try {
    ws = new WebSocket(`wss://ws.finnhub.io?token=${key}`);
    ws.onopen = () => {
      S.wsConnected = true;
      S.tickers.forEach(t => ws.send(JSON.stringify({type:'subscribe',symbol:t})));
      updateUI();
    };
    ws.onmessage = (evt) => {
      try {
        const msg = JSON.parse(evt.data);
        if(msg.type==='trade' && msg.data) {
          for(const trade of msg.data) {
            if(!S.tickers.includes(trade.s)) continue;
            const ex = S.prices[trade.s] || {};
            if(ex.price) S.prevSnapshot[trade.s] = ex.price;
            S.prices[trade.s] = { ...ex, price:trade.p, lastTrade:trade.t, high:Math.max(ex.high||0,trade.p), low:Math.min(ex.low||999999,trade.p), source:'finnhub-ws' };
            if(S.tickerData[trade.s]?.quote) S.tickerData[trade.s].quote.c = trade.p;
          }
          S.wsLast = new Date();
          updateUI();
        }
      } catch(e) {}
    };
    ws.onerror = () => { S.wsConnected=false; updateUI(); };
    ws.onclose = () => { S.wsConnected=false; updateUI(); setTimeout(connectWS, 5000); };
  } catch(e) { S.wsConnected=false; }
}

function wsSubscribe(ticker) {
  if(ws?.readyState === 1) ws.send(JSON.stringify({type:'subscribe',symbol:ticker}));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SUPABASE OPERATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadWatchlist() {
  if(!sb) return;
  const data = await sb.select('watchlist', 'order=added_at.desc');
  if(data && Array.isArray(data)) {
    for(const row of data) {
      if(!S.tickers.includes(row.symbol)) {
        S.tickers.push(row.symbol);
        await fetchTickerData(row.symbol);
        wsSubscribe(row.symbol);
      }
    }
    updateUI();
  }
}

async function saveToWatchlist(symbol) {
  if(!sb) return;
  await sb.upsert('watchlist', { symbol, added_at: new Date().toISOString() });
}

async function removeFromWatchlist(symbol) {
  if(!sb) return;
  await sb.delete('watchlist', `symbol=eq.${symbol}`);
}

async function saveSnapshot() {
  if(!sb || S.tickers.length === 0) return;
  const snapshots = [];
  for(const t of S.tickers) {
    const sc = calcAll(t);
    if(!sc) continue;
    const s = sig(sc.comp);
    snapshots.push({
      symbol: t, composite_score: Math.round(sc.comp), signal: s.label,
      tech_score: sc.tech, value_score: sc.val, catalyst_score: sc.cat, volatility_score: sc.vol,
      price: S.prices[t]?.price || 0, snapshot_at: new Date().toISOString()
    });
  }
  if(snapshots.length) await sb.insert('signal_snapshots', snapshots);
}

async function loadTrades() {
  if(!sb) return;
  const data = await sb.select('paper_trades', 'order=created_at.desc');
  if(data && Array.isArray(data)) S.tradeHistory = data;
  const portfolio = await sb.select('portfolio', 'limit=1');
  if(portfolio?.[0]) {
    S.portfolio.cash = portfolio[0].cash || 10000;
    S.portfolio.startValue = portfolio[0].start_value || 10000;
  }
  // Derive open positions from trades
  derivePositions();
}

function derivePositions() {
  const posMap = {};
  const sorted = [...S.tradeHistory].sort((a,b) => new Date(a.created_at) - new Date(b.created_at));
  for(const t of sorted) {
    if(!posMap[t.symbol]) posMap[t.symbol] = { symbol:t.symbol, shares:0, totalCost:0 };
    if(t.type === 'BUY') {
      posMap[t.symbol].totalCost += t.shares * t.price;
      posMap[t.symbol].shares += t.shares;
    } else {
      posMap[t.symbol].shares -= t.shares;
      if(posMap[t.symbol].shares <= 0) { posMap[t.symbol].shares = 0; posMap[t.symbol].totalCost = 0; }
    }
  }
  S.positions = Object.values(posMap).filter(p => p.shares > 0).map(p => ({
    ...p, avgCost: p.shares > 0 ? p.totalCost / p.shares : 0
  }));
}

async function executeTrade(symbol, type, shares, price) {
  const cost = shares * price;
  if(type === 'BUY' && cost > S.portfolio.cash) { showToast('Insufficient cash!', 'error'); return; }
  if(type === 'SELL') {
    const pos = S.positions.find(p => p.symbol === symbol);
    if(!pos || pos.shares < shares) { showToast('Insufficient shares!', 'error'); return; }
  }

  const trade = { symbol, type, shares, price, total: cost, created_at: new Date().toISOString() };
  if(type === 'SELL') {
    const pos = S.positions.find(p => p.symbol === symbol);
    if(pos) trade.pnl = (price - pos.avgCost) * shares;
  }

  if(sb) await sb.insert('paper_trades', trade);
  S.tradeHistory.unshift(trade);

  if(type === 'BUY') S.portfolio.cash -= cost;
  else S.portfolio.cash += cost;

  if(sb) await sb.upsert('portfolio', { id: 1, cash: S.portfolio.cash, start_value: S.portfolio.startValue, updated_at: new Date().toISOString() });

  derivePositions();
  showToast(`${type} ${shares} ${symbol} @ $${price.toFixed(2)}`, 'success');
  updateUI();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ADD TICKER (from search)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function addTicker(symbol) {
  if(S.tickers.includes(symbol)) { showToast(`${symbol} already on watchlist`, 'error'); return; }
  S.tickers.push(symbol);
  showToast(`Adding ${symbol}...`);
  await fetchTickerData(symbol);
  await saveToWatchlist(symbol);
  wsSubscribe(symbol);
  if(!S.selected) S.selected = symbol;
  render();
  updateUI();
}

async function removeTicker(symbol) {
  S.tickers = S.tickers.filter(t => t !== symbol);
  delete S.tickerData[symbol];
  delete S.prices[symbol];
  await removeFromWatchlist(symbol);
  if(S.selected === symbol) S.selected = S.tickers[0] || null;
  render();
  updateUI();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  WEIGHT HANDLING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function adjustWeight(key, newVal) {
  const others = Object.keys(S.weights).filter(k=>k!==key);
  const rem = 100-newVal, curSum = others.reduce((a,k)=>a+S.weights[k],0);
  S.weights[key] = newVal;
  others.forEach(k => { S.weights[k] = curSum>0 ? Math.round((S.weights[k]/curSum)*rem) : Math.round(rem/3) });
  const diff = 100 - Object.values(S.weights).reduce((a,b)=>a+b,0);
  if(diff!==0) S.weights[others[0]] += diff;
  localStorage.setItem('signal_weights', JSON.stringify(S.weights));
  others.concat([key]).forEach(k => {
    const el=document.getElementById(`w-val-${k}`); if(el) el.textContent=S.weights[k]+'%';
    const sl=document.getElementById(`w-slider-${k}`); if(sl) sl.value=S.weights[k];
  });
  updateUI();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function render() {
  const app = document.getElementById('app');
  app.innerHTML = `
  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <div class="mono" style="font-size:9px;color:var(--blue);letter-spacing:2px;margin-bottom:3px">PROJECT ARES v4.0</div>
      <h1 class="mono">Entry Signal Engine</h1>
      <div class="status-row mono" id="status-row">
        <span class="dot ${S.wsConnected?'ws':S.lastPoll?'live':'off'}" id="status-dot"></span>
        <span id="status-label">${S.wsConnected?'REAL-TIME (WS)':S.lastPoll?'FINNHUB REST':'CONNECTING...'}</span>
        <span>‚Ä¢</span>
        <span id="status-time">${S.lastPoll?S.lastPoll.toLocaleTimeString():'‚Äî'}</span>
        <span>‚Ä¢ Next: <span id="countdown">${S.countdown}</span>s</span>
        <span style="color:var(--blue);cursor:pointer" onclick="pollAllQuotes()">‚Üª</span>
      </div>
    </div>
    <div style="display:flex;gap:6px;align-items:center">
      <span class="mono" style="font-size:9px;color:var(--text-3)">${S.tickers.length} tickers</span>
      ${sb ? '<span class="mono" style="font-size:9px;color:var(--green)">‚óè Supabase</span>' : ''}
    </div>
  </div>

  <!-- Market bar -->
  <div class="market-row">
    <div class="market-chip"><div class="mono lbl">VIXY (VIX)</div><div class="mono val" id="mkt-vix">‚Äî</div><div class="mono chg" id="mkt-vix-chg">‚Äî</div></div>
    <div class="market-chip"><div class="mono lbl">SPY (S&P)</div><div class="mono val" id="mkt-sp">‚Äî</div><div class="mono chg" id="mkt-sp-chg">‚Äî</div></div>
    <div class="market-chip"><div class="mono lbl">QQQ (NDX)</div><div class="mono val" id="mkt-ndx">‚Äî</div><div class="mono chg" id="mkt-ndx-chg">‚Äî</div></div>
    <div class="market-chip"><div class="mono lbl">FEAR / GREED</div><div class="mono val" id="mkt-fg">‚Äî</div><div class="mono chg" id="mkt-fg-lbl" style="color:var(--text-3)">‚Äî</div></div>
  </div>

  <!-- Tabs -->
  <div class="tab-bar">
    <button class="tab-btn ${S.activeTab==='signals'?'active':''}" onclick="switchTab('signals')">üì° SIGNALS</button>
    <button class="tab-btn ${S.activeTab==='trading'?'active':''}" onclick="switchTab('trading')">üí∞ PAPER TRADING</button>
    <button class="tab-btn ${S.activeTab==='performance'?'active':''}" onclick="switchTab('performance')">üìä PERFORMANCE</button>
  </div>

  <!-- Tab: Signals -->
  <div class="tab-content ${S.activeTab==='signals'?'active':''}" id="tab-signals">
    ${renderSignalsTab()}
  </div>

  <!-- Tab: Paper Trading -->
  <div class="tab-content ${S.activeTab==='trading'?'active':''}" id="tab-trading">
    ${renderTradingTab()}
  </div>

  <!-- Tab: Performance -->
  <div class="tab-content ${S.activeTab==='performance'?'active':''}" id="tab-performance">
    ${renderPerformanceTab()}
  </div>

  <!-- Footer -->
  <div class="footer mono">
    <span style="color:var(--blue);font-weight:700;letter-spacing:1px">PROJECT ARES v4.0</span> ‚Ä¢
    Dynamic scoring ‚Ä¢ Supabase persistence ‚Ä¢ Paper trading<br>
    <strong>TECH</strong>: 52w range position, drawdown, beta, price vs midrange ‚Ä¢
    <strong>VALUE</strong>: P/E, PEG, analyst target upside, buy/sell ratio ‚Ä¢
    <strong>CATALYST</strong>: Earnings proximity, analyst consensus, market cap ‚Ä¢
    <strong>VOL</strong>: VIX, Fear/Greed, P/C ratio, beta<br>
    <strong>SIGNALS</strong>: STRONG BUY (75+) ‚Üí BUY (60+) ‚Üí ACCUMULATE (45+) ‚Üí WAIT (30+) ‚Üí AVOID (&lt;30)
    <div class="warn">‚ö† Decision-support tool only. Not financial advice. Paper trades are simulated.</div>
  </div>`;

  attachSearchListeners();
}

function renderSignalsTab() {
  const sorted = [...S.tickers].sort((a,b) => {
    const sa = calcAll(a), sb2 = calcAll(b);
    return (sb2?.comp||0) - (sa?.comp||0);
  });

  return `
  <!-- Search -->
  <div class="search-container">
    <div class="search-row" style="position:relative">
      <span class="search-icon">üîç</span>
      <input class="search-input" id="search-input" type="text" placeholder="Search any ticker... (e.g. AAPL, TSLA, AMZN)" autocomplete="off">
    </div>
    <div class="search-results" id="search-results"></div>
  </div>

  <!-- Weights -->
  <div class="weights-panel">
    <div class="mono" style="font-size:8px;color:var(--text-3);letter-spacing:1px;margin-bottom:8px">FACTOR WEIGHTS</div>
    <div class="weights-grid">
      ${['technical','value','catalyst','volatility'].map((k,i) => {
        const colors=['var(--blue)','var(--purple)','var(--amber)','var(--red)'];
        const labels=['TECHNICAL','VALUE','CATALYST','VOLATILITY'];
        return `<div class="weight-item">
          <label class="mono"><span style="color:${colors[i]}">${labels[i]}</span><span style="color:var(--text-0);font-weight:700" id="w-val-${k}">${S.weights[k]}%</span></label>
          <input type="range" min="5" max="55" value="${S.weights[k]}" id="w-slider-${k}" oninput="adjustWeight('${k}',parseInt(this.value))">
        </div>`;
      }).join('')}
    </div>
  </div>

  ${S.tickers.length === 0 ? `
    <div style="text-align:center;padding:60px 20px;color:var(--text-2)">
      <div style="font-size:40px;margin-bottom:16px">üîç</div>
      <div style="font-size:16px;font-weight:600;margin-bottom:8px">Search for a ticker to get started</div>
      <div style="font-size:12px;color:var(--text-3)">Type any stock symbol above to analyze entry signals</div>
    </div>
  ` : `
    <!-- Cards -->
    <div class="cards-grid" id="cards-grid">
      ${sorted.map(t => renderCard(t)).join('')}
    </div>

    <!-- Detail panel -->
    ${S.selected && S.tickerData[S.selected] ? renderDetail(S.selected) : ''}
  `}`;
}

function renderCard(t) {
  const td = S.tickerData[t] || {};
  const sc = calcAll(t);
  const p = S.prices[t];
  const isSel = S.selected === t;
  const color = td.color || tickerColor(t);
  const name = td.name || td.profile?.name || t;

  let priceStr = '‚Äî', chgStr = '‚Äî', chgClass = '';
  if(p?.price) {
    priceStr = '$' + p.price.toFixed(2);
    if(p.prevClose) {
      const chg = ((p.price - p.prevClose)/p.prevClose*100);
      chgStr = (chg>=0?'+':'') + chg.toFixed(2) + '%';
      chgClass = chg >= 0 ? 'up' : 'dn';
    }
  }

  const s = sc ? sig(sc.comp) : {label:'LOADING',color:'var(--text-3)',bg:'transparent'};
  const m = td.metrics || {};
  const dd = m['52WeekHigh'] ? ((m['52WeekHigh'] - (p?.price||0)) / m['52WeekHigh'] * 100).toFixed(1) : '‚Äî';

  return `<div class="ticker-card ${isSel?'selected':''}" onclick="selectTicker('${t}')" style="${isSel?`border-color:${color}40`:''}">
    <div class="accent" style="background:linear-gradient(90deg,${color},transparent)"></div>
    <button class="remove-btn" onclick="event.stopPropagation();removeTicker('${t}')" title="Remove">‚úï</button>
    <div class="top">
      <div><div class="mono sym">${t} ${p?.source==='finnhub-ws'?'<span style="font-size:7px;color:var(--blue)">‚ö°</span>':''}</div><div class="nm">${name}</div></div>
      <div class="signal-badge mono" style="background:${s.bg};color:${s.color};border:1px solid ${s.color}25">${s.label}</div>
    </div>
    <div class="price-row">
      <span class="mono price live-num" id="price-${t}">${priceStr}</span>
      <span class="mono day-chg ${chgClass}" id="chg-${t}">${chgStr}</span>
    </div>
    <div class="meta-row mono">
      <span>ATH -${dd}%</span>
      ${sc?`<span>RSI ~${sc.rsi.toFixed(0)}</span>`:''}
      ${m.pegRatio?`<span>PEG ${m.pegRatio.toFixed(2)}</span>`:''}
      ${sc?.dte<999?`<span>E: ${sc.dte}d</span>`:''}
    </div>
    ${sc ? `
    <div class="score-bar"><div class="bar-hdr mono"><span>TECH</span><span class="bv">${sc.tech}</span></div><div class="bar-track"><div class="bar-fill" style="width:${sc.tech}%;background:var(--blue)"></div></div></div>
    <div class="score-bar"><div class="bar-hdr mono"><span>VALUE</span><span class="bv">${sc.val}</span></div><div class="bar-track"><div class="bar-fill" style="width:${sc.val}%;background:var(--purple)"></div></div></div>
    <div class="score-bar"><div class="bar-hdr mono"><span>CAT</span><span class="bv">${sc.cat}</span></div><div class="bar-track"><div class="bar-fill" style="width:${sc.cat}%;background:var(--amber)"></div></div></div>
    <div class="score-bar"><div class="bar-hdr mono"><span>VOL</span><span class="bv">${sc.vol}</span></div><div class="bar-track"><div class="bar-fill" style="width:${sc.vol}%;background:var(--red)"></div></div></div>
    <div class="composite-row"><span class="mono cl">COMPOSITE</span><span class="mono cv" style="color:${s.color}">${sc.comp.toFixed(0)}</span></div>
    ` : '<div style="text-align:center;padding:10px"><div class="spinner"></div></div>'}
    <div class="card-actions">
      <button class="btn btn-sm btn-green mono" onclick="event.stopPropagation();quickBuy('${t}')">BUY</button>
      <button class="btn btn-sm btn-red mono" onclick="event.stopPropagation();quickSell('${t}')">SELL</button>
    </div>
  </div>`;
}

function renderDetail(t) {
  const td = S.tickerData[t] || {};
  const sc = calcAll(t);
  const p = S.prices[t];
  const m = td.metrics || {};
  const pt = td.priceTarget || {};
  const color = td.color || tickerColor(t);
  const name = td.name || t;
  if(!sc || !p?.price) return '';

  const s = sig(sc.comp);
  const dd = m['52WeekHigh'] ? ((m['52WeekHigh'] - p.price) / m['52WeekHigh'] * 100).toFixed(1) : '‚Äî';
  const upside = pt.targetMean ? ((pt.targetMean - p.price) / p.price * 100).toFixed(1) : '‚Äî';
  const dayChg = p.prevClose ? ((p.price-p.prevClose)/p.prevClose*100).toFixed(2) : '‚Äî';

  const metrics = [
    {l:'Price',v:`$${p.price.toFixed(2)}`},
    {l:'Day Change',v:`${parseFloat(dayChg)>=0?'+':''}${dayChg}%`,w:parseFloat(dayChg)<-3},
    {l:'Day Range',v:`$${(p.low||0).toFixed(2)}‚Äì$${(p.high||0).toFixed(2)}`},
    {l:'52W High',v:m['52WeekHigh']?`$${m['52WeekHigh'].toFixed(2)} (‚àí${dd}%)`:'‚Äî'},
    {l:'52W Low',v:m['52WeekLow']?`$${m['52WeekLow'].toFixed(2)}`:'‚Äî'},
    {l:'Beta',v:m.beta?.toFixed(2)||'‚Äî',w:m.beta>1.5},
    {l:'P/E',v:m.peNormalizedAnnual?.toFixed(1)||'‚Äî'},
    {l:'PEG',v:m.pegRatio?.toFixed(2)||'‚Äî',w:m.pegRatio&&m.pegRatio<0.5},
    {l:'Target',v:pt.targetMean?`$${pt.targetMean.toFixed(2)} (+${upside}%)`:'‚Äî'},
    {l:'Earnings',v:sc.dte<999?`${sc.dte} days`:'‚Äî',w:sc.dte>=10&&sc.dte<=25},
    {l:'P/C Ratio',v:td.options?.pcRatio?.toFixed(2)||'‚Äî',w:td.options?.pcRatio>1.2},
    {l:'Call OI',v:td.options?.callOI?.toLocaleString()||'‚Äî'},
    {l:'Put OI',v:td.options?.putOI?.toLocaleString()||'‚Äî'},
    {l:'Market Cap',v:td.profile?.marketCapitalization?`$${(td.profile.marketCapitalization/1000).toFixed(1)}B`:'‚Äî'},
    {l:'Industry',v:td.profile?.finnhubIndustry||'‚Äî'},
    {l:'Source',v:p.source==='finnhub-ws'?'‚ö° Real-time':'üìä REST'},
  ];

  let factors = [];
  if(sc.tech>=60) factors.push('‚úÖ Technically oversold ‚Äî good entry zone');
  else if(sc.tech>=40) factors.push('‚û°Ô∏è Technicals moderate');
  else factors.push('‚ö†Ô∏è Could fall further');
  if(sc.val>=60) factors.push('‚úÖ Strong fundamental value');
  else if(sc.val<40) factors.push('‚ö†Ô∏è Valuation elevated');
  if(sc.cat>=60) factors.push('‚úÖ Catalyst approaching');
  else if(sc.cat<40) factors.push('‚ö†Ô∏è No near-term catalyst');
  if(sc.vol>=50) factors.push('‚úÖ Elevated fear ‚Äî good for entries');
  else if(sc.vol<30) factors.push('‚ö†Ô∏è Low fear ‚Äî may not have bottomed');
  if(sc.dte>=10 && sc.dte<=25) factors.push('üéØ Pre-earnings sweet spot');
  if(dd !== '‚Äî' && parseFloat(dd)>20) factors.push(`üí∞ ${dd}% off 52W high`);

  return `<div class="detail-panel slide-in">
    <div class="detail-header">
      <div class="detail-title">
        <div class="bar" style="background:${color}"></div>
        <div><h2 class="mono">${t} ‚Äî ${name}</h2>
          <div class="sub">${td.profile?.finnhubIndustry||''} ${td.profile?.exchange?'‚Ä¢ '+td.profile.exchange:''}</div></div>
      </div>
      <div class="detail-signal mono" style="background:${s.bg};color:${s.color};border:1px solid ${s.color}25">${sc.comp.toFixed(0)} ‚Äî ${s.label}</div>
    </div>
    <div class="metrics-grid">${metrics.map(mt=>`<div class="metric-box"><div class="mono ml">${mt.l}</div><div class="mono mv ${mt.w?'warn':''}">${mt.v}</div></div>`).join('')}</div>
    <div class="detail-cols">
      <div><div class="mono section-title">SCORE BREAKDOWN</div>
        <div class="score-bar"><div class="bar-hdr mono"><span>TECHNICAL (√ó${S.weights.technical}%)</span><span class="bv">${sc.tech}</span></div><div class="bar-track"><div class="bar-fill" style="width:${sc.tech}%;background:var(--blue)"></div></div></div>
        <div class="score-bar"><div class="bar-hdr mono"><span>VALUE (√ó${S.weights.value}%)</span><span class="bv">${sc.val}</span></div><div class="bar-track"><div class="bar-fill" style="width:${sc.val}%;background:var(--purple)"></div></div></div>
        <div class="score-bar"><div class="bar-hdr mono"><span>CATALYST (√ó${S.weights.catalyst}%)</span><span class="bv">${sc.cat}</span></div><div class="bar-track"><div class="bar-fill" style="width:${sc.cat}%;background:var(--amber)"></div></div></div>
        <div class="score-bar"><div class="bar-hdr mono"><span>VOLATILITY (√ó${S.weights.volatility}%)</span><span class="bv">${sc.vol}</span></div><div class="bar-track"><div class="bar-fill" style="width:${sc.vol}%;background:var(--red)"></div></div></div>
      </div>
      <div><div class="mono section-title">DECISION FACTORS</div>
        <div class="factors">${factors.map(f=>`<div>${f}</div>`).join('')}</div></div>
    </div>
  </div>`;
}

function renderTradingTab() {
  const totalValue = getTotalPortfolioValue();
  const totalPnL = totalValue - S.portfolio.startValue;
  const totalPnLPct = S.portfolio.startValue > 0 ? (totalPnL / S.portfolio.startValue * 100) : 0;
  const positionsValue = S.positions.reduce((a, p) => a + (p.shares * (S.prices[p.symbol]?.price || p.avgCost)), 0);

  return `
  <!-- Portfolio Summary -->
  <div class="portfolio-summary">
    <div class="port-card">
      <div class="mono port-lbl">TOTAL VALUE</div>
      <div class="mono port-val">$${totalValue.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}</div>
      <div class="mono port-sub ${totalPnL>=0?'up':'dn'}">${totalPnL>=0?'+':''}$${totalPnL.toFixed(2)} (${totalPnLPct>=0?'+':''}${totalPnLPct.toFixed(2)}%)</div>
    </div>
    <div class="port-card">
      <div class="mono port-lbl">CASH</div>
      <div class="mono port-val">$${S.portfolio.cash.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}</div>
      <div class="mono port-sub" style="color:var(--text-3)">${totalValue>0?(S.portfolio.cash/totalValue*100).toFixed(1):100}% of portfolio</div>
    </div>
    <div class="port-card">
      <div class="mono port-lbl">INVESTED</div>
      <div class="mono port-val">$${positionsValue.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}</div>
      <div class="mono port-sub" style="color:var(--text-3)">${S.positions.length} positions</div>
    </div>
    <div class="port-card">
      <div class="mono port-lbl">STARTING</div>
      <div class="mono port-val">$${S.portfolio.startValue.toLocaleString()}</div>
      <div class="mono port-sub" style="color:var(--text-3)">Paper portfolio</div>
    </div>
  </div>

  <!-- Trade Form -->
  <div class="trade-form">
    <h3 class="mono" style="color:var(--blue)">üìù New Trade</h3>
    <div class="form-row">
      <span class="form-label mono">Symbol</span>
      <input class="form-input" id="trade-symbol" type="text" placeholder="AAPL" list="ticker-list">
      <datalist id="ticker-list">${S.tickers.map(t=>`<option value="${t}">`).join('')}</datalist>
      <span class="form-label mono">Shares</span>
      <input class="form-input" id="trade-shares" type="number" placeholder="10" min="1" style="width:80px">
      <span class="form-label mono">Price</span>
      <input class="form-input" id="trade-price" type="number" placeholder="Auto" step="0.01" style="width:100px">
      <button class="btn btn-green mono" onclick="submitTrade('BUY')">BUY</button>
      <button class="btn btn-red mono" onclick="submitTrade('SELL')">SELL</button>
    </div>
  </div>

  <!-- Open Positions -->
  <div style="margin-bottom:14px">
    <div class="mono section-title" style="margin-bottom:10px">OPEN POSITIONS</div>
    ${S.positions.length === 0 ? '<div style="color:var(--text-3);font-size:12px;padding:20px;text-align:center">No open positions</div>' : `
    <table class="positions-table">
      <thead><tr>
        <th class="mono">SYMBOL</th><th class="mono">SHARES</th><th class="mono">AVG COST</th>
        <th class="mono">CURRENT</th><th class="mono">VALUE</th><th class="mono">P&L</th><th class="mono">ACTION</th>
      </tr></thead>
      <tbody>
        ${S.positions.map(pos => {
          const cur = S.prices[pos.symbol]?.price || pos.avgCost;
          const val = pos.shares * cur;
          const pnl = (cur - pos.avgCost) * pos.shares;
          const pnlPct = pos.avgCost > 0 ? ((cur - pos.avgCost) / pos.avgCost * 100) : 0;
          return `<tr>
            <td class="mono" style="font-weight:700">${pos.symbol}</td>
            <td class="mono">${pos.shares}</td>
            <td class="mono">$${pos.avgCost.toFixed(2)}</td>
            <td class="mono">$${cur.toFixed(2)}</td>
            <td class="mono">$${val.toFixed(2)}</td>
            <td class="mono ${pnl>=0?'up':'dn'}">${pnl>=0?'+':''}$${pnl.toFixed(2)} (${pnlPct>=0?'+':''}${pnlPct.toFixed(1)}%)</td>
            <td><button class="btn btn-sm btn-red mono" onclick="executeTrade('${pos.symbol}','SELL',${pos.shares},${cur})">SELL ALL</button></td>
          </tr>`;
        }).join('')}
      </tbody>
    </table>`}
  </div>

  <!-- Trade History -->
  <div>
    <div class="mono section-title" style="margin-bottom:10px">TRADE HISTORY</div>
    ${S.tradeHistory.length === 0 ? '<div style="color:var(--text-3);font-size:12px;padding:20px;text-align:center">No trades yet</div>' : `
    <table class="positions-table">
      <thead><tr><th class="mono">DATE</th><th class="mono">TYPE</th><th class="mono">SYMBOL</th><th class="mono">SHARES</th><th class="mono">PRICE</th><th class="mono">TOTAL</th><th class="mono">P&L</th></tr></thead>
      <tbody>
        ${S.tradeHistory.slice(0,20).map(t => {
          const date = new Date(t.created_at).toLocaleDateString();
          return `<tr>
            <td class="mono" style="font-size:10px">${date}</td>
            <td class="mono" style="color:${t.type==='BUY'?'var(--green)':'var(--red)'}"><strong>${t.type}</strong></td>
            <td class="mono" style="font-weight:700">${t.symbol}</td>
            <td class="mono">${t.shares}</td>
            <td class="mono">$${t.price?.toFixed(2)||'‚Äî'}</td>
            <td class="mono">$${t.total?.toFixed(2)||'‚Äî'}</td>
            <td class="mono ${(t.pnl||0)>=0?'up':'dn'}">${t.pnl!=null?`${t.pnl>=0?'+':''}$${t.pnl.toFixed(2)}`:'‚Äî'}</td>
          </tr>`;
        }).join('')}
      </tbody>
    </table>`}
  </div>`;
}

function renderPerformanceTab() {
  const closedTrades = S.tradeHistory.filter(t => t.type === 'SELL' && t.pnl != null);
  const wins = closedTrades.filter(t => t.pnl > 0);
  const winRate = closedTrades.length > 0 ? (wins.length / closedTrades.length * 100) : 0;
  const avgReturn = closedTrades.length > 0 ? closedTrades.reduce((a,t) => a + t.pnl, 0) / closedTrades.length : 0;
  const bestTrade = closedTrades.length > 0 ? closedTrades.reduce((a,t) => t.pnl > a.pnl ? t : a, closedTrades[0]) : null;
  const worstTrade = closedTrades.length > 0 ? closedTrades.reduce((a,t) => t.pnl < a.pnl ? t : a, closedTrades[0]) : null;
  const totalPnL = closedTrades.reduce((a,t) => a + t.pnl, 0);
  const totalValue = getTotalPortfolioValue();

  // Factor analysis
  const factorWins = {};
  for(const t of S.tickers) {
    const sc = calcAll(t);
    if(!sc) continue;
    const s = sig(sc.comp);
    factorWins[t] = { signal: s.label, comp: sc.comp, tech: sc.tech, val: sc.val, cat: sc.cat, vol: sc.vol };
  }

  return `
  <!-- Performance Cards -->
  <div class="perf-grid">
    <div class="perf-card">
      <div class="mono perf-lbl">TOTAL P&L</div>
      <div class="mono perf-val ${totalPnL>=0?'up':'dn'}">${totalPnL>=0?'+':''}$${totalPnL.toFixed(2)}</div>
      <div class="mono" style="font-size:10px;color:var(--text-3)">${closedTrades.length} closed trades</div>
    </div>
    <div class="perf-card">
      <div class="mono perf-lbl">WIN RATE</div>
      <div class="mono perf-val" style="color:${winRate>=50?'var(--green)':'var(--red)'}">${winRate.toFixed(1)}%</div>
      <div class="mono" style="font-size:10px;color:var(--text-3)">${wins.length}W / ${closedTrades.length-wins.length}L</div>
    </div>
    <div class="perf-card">
      <div class="mono perf-lbl">AVG RETURN</div>
      <div class="mono perf-val ${avgReturn>=0?'up':'dn'}">${avgReturn>=0?'+':''}$${avgReturn.toFixed(2)}</div>
      <div class="mono" style="font-size:10px;color:var(--text-3)">per trade</div>
    </div>
    <div class="perf-card">
      <div class="mono perf-lbl">PORTFOLIO VALUE</div>
      <div class="mono perf-val">$${totalValue.toLocaleString(undefined,{maximumFractionDigits:0})}</div>
      <div class="mono" style="font-size:10px;color:var(--text-3)">started at $${S.portfolio.startValue.toLocaleString()}</div>
    </div>
    <div class="perf-card">
      <div class="mono perf-lbl">BEST TRADE</div>
      <div class="mono perf-val up">${bestTrade?`+$${bestTrade.pnl.toFixed(2)}`:'‚Äî'}</div>
      <div class="mono" style="font-size:10px;color:var(--text-3)">${bestTrade?bestTrade.symbol:'‚Äî'}</div>
    </div>
    <div class="perf-card">
      <div class="mono perf-lbl">WORST TRADE</div>
      <div class="mono perf-val dn">${worstTrade?`$${worstTrade.pnl.toFixed(2)}`:'‚Äî'}</div>
      <div class="mono" style="font-size:10px;color:var(--text-3)">${worstTrade?worstTrade.symbol:'‚Äî'}</div>
    </div>
  </div>

  <!-- Portfolio Value Chart -->
  <div class="chart-container">
    <h3 class="mono">PORTFOLIO VALUE OVER TIME</h3>
    <div id="portfolio-chart" style="height:200px">${renderPortfolioChart()}</div>
  </div>

  <!-- Factor Analysis -->
  <div class="chart-container">
    <h3 class="mono">FACTOR ANALYSIS ‚Äî CURRENT WATCHLIST</h3>
    ${S.tickers.length === 0 ? '<div style="color:var(--text-3);padding:20px;text-align:center">Add tickers to see factor analysis</div>' : `
    <table class="positions-table">
      <thead><tr><th class="mono">SYMBOL</th><th class="mono">SIGNAL</th><th class="mono">COMP</th><th class="mono">TECH</th><th class="mono">VALUE</th><th class="mono">CAT</th><th class="mono">VOL</th></tr></thead>
      <tbody>
        ${Object.entries(factorWins).map(([sym, f]) => {
          const s = sig(f.comp);
          return `<tr>
            <td class="mono" style="font-weight:700">${sym}</td>
            <td class="mono" style="color:${s.color}">${f.signal}</td>
            <td class="mono" style="color:${s.color};font-weight:700">${f.comp.toFixed(0)}</td>
            <td class="mono">${f.tech}</td>
            <td class="mono">${f.val}</td>
            <td class="mono">${f.cat}</td>
            <td class="mono">${f.vol}</td>
          </tr>`;
        }).join('')}
      </tbody>
    </table>`}
  </div>

  <!-- Signal Distribution -->
  <div class="chart-container">
    <h3 class="mono">SIGNAL STRENGTH DISTRIBUTION</h3>
    <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:12px">
      ${['STRONG BUY','BUY','ACCUMULATE','WAIT','AVOID'].map(label => {
        const s = sig(label==='STRONG BUY'?80:label==='BUY'?65:label==='ACCUMULATE'?50:label==='WAIT'?35:15);
        const count = Object.values(factorWins).filter(f => sig(f.comp).label === label).length;
        return `<div style="text-align:center;flex:1;min-width:80px">
          <div style="background:${s.bg};border:1px solid ${s.color}25;border-radius:8px;padding:12px">
            <div class="mono" style="font-size:24px;font-weight:800;color:${s.color}">${count}</div>
            <div class="mono" style="font-size:8px;color:${s.color};margin-top:4px">${label}</div>
          </div>
        </div>`;
      }).join('')}
    </div>
  </div>`;
}

function renderPortfolioChart() {
  const totalValue = getTotalPortfolioValue();
  // Build data points from trade history
  const points = [{date:'Start', value:S.portfolio.startValue}];
  let cash = S.portfolio.startValue;
  const sorted = [...S.tradeHistory].sort((a,b) => new Date(a.created_at) - new Date(b.created_at));
  for(const t of sorted) {
    if(t.type === 'BUY') cash -= t.total;
    else cash += t.total;
    points.push({date:new Date(t.created_at).toLocaleDateString(), value:cash + (t.pnl||0)});
  }
  points.push({date:'Now', value:totalValue});

  if(points.length < 2) return '<div style="color:var(--text-3);text-align:center;padding:40px">Make some trades to see the chart</div>';

  const maxVal = Math.max(...points.map(p=>p.value));
  const minVal = Math.min(...points.map(p=>p.value));
  const range = maxVal - minVal || 1;
  const w = 800, h = 180, pad = 30;

  const xStep = (w - pad*2) / (points.length - 1);
  const pathPoints = points.map((p, i) => {
    const x = pad + i * xStep;
    const y = h - pad - ((p.value - minVal) / range) * (h - pad*2);
    return `${x},${y}`;
  });

  const startColor = totalValue >= S.portfolio.startValue ? '#10B981' : '#EF4444';

  return `<svg viewBox="0 0 ${w} ${h}" style="width:100%;height:100%">
    <defs>
      <linearGradient id="chartGrad" x1="0" y1="0" x2="0" y2="1">
        <stop offset="0%" stop-color="${startColor}" stop-opacity="0.3"/>
        <stop offset="100%" stop-color="${startColor}" stop-opacity="0"/>
      </linearGradient>
    </defs>
    <!-- Grid lines -->
    ${[0,0.25,0.5,0.75,1].map(pct => {
      const y = h - pad - pct * (h - pad*2);
      const val = minVal + pct * range;
      return `<line x1="${pad}" y1="${y}" x2="${w-pad}" y2="${y}" stroke="#1C2030" stroke-width="1"/>
        <text x="${pad-4}" y="${y+3}" fill="#3A4058" font-size="8" font-family="JetBrains Mono" text-anchor="end">$${val.toFixed(0)}</text>`;
    }).join('')}
    <!-- Area -->
    <polygon points="${pad},${h-pad} ${pathPoints.join(' ')} ${pad+(points.length-1)*xStep},${h-pad}" fill="url(#chartGrad)"/>
    <!-- Line -->
    <polyline points="${pathPoints.join(' ')}" fill="none" stroke="${startColor}" stroke-width="2" stroke-linejoin="round"/>
    <!-- Dots -->
    ${pathPoints.map((pt, i) => `<circle cx="${pt.split(',')[0]}" cy="${pt.split(',')[1]}" r="3" fill="${startColor}" stroke="var(--bg-0)" stroke-width="1.5"/>`).join('')}
    <!-- Labels -->
    ${points.map((p, i) => {
      const x = pad + i * xStep;
      return points.length <= 10 ? `<text x="${x}" y="${h-8}" fill="#3A4058" font-size="7" font-family="JetBrains Mono" text-anchor="middle">${p.date}</text>` : '';
    }).join('')}
  </svg>`;
}

function getTotalPortfolioValue() {
  const posValue = S.positions.reduce((a, p) => a + (p.shares * (S.prices[p.symbol]?.price || p.avgCost)), 0);
  return S.portfolio.cash + posValue;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  UI UPDATES (no full re-render)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateUI() {
  // Market chips
  setText('mkt-vix', (S.market.vix||0).toFixed(2));
  const vChg = S.market.vixPrev ? ((S.market.vix-S.market.vixPrev)/S.market.vixPrev*100).toFixed(2) : '0';
  setText('mkt-vix-chg', (parseFloat(vChg)>=0?'+':'')+vChg+'%');
  setColor('mkt-vix-chg', parseFloat(vChg)>0?'var(--red-bright)':'var(--green-bright)');

  setText('mkt-sp', (S.market.sp500||0).toLocaleString(undefined,{maximumFractionDigits:0}));
  const sChg = S.market.sp500Prev ? ((S.market.sp500-S.market.sp500Prev)/S.market.sp500Prev*100).toFixed(2) : '0';
  setText('mkt-sp-chg', (parseFloat(sChg)>=0?'+':'')+sChg+'%');
  setColor('mkt-sp-chg', parseFloat(sChg)>=0?'var(--green-bright)':'var(--red-bright)');

  setText('mkt-ndx', (S.market.ndx||0).toLocaleString(undefined,{maximumFractionDigits:0}));
  const nChg = S.market.ndxPrev ? ((S.market.ndx-S.market.ndxPrev)/S.market.ndxPrev*100).toFixed(2) : '0';
  setText('mkt-ndx-chg', (parseFloat(nChg)>=0?'+':'')+nChg+'%');
  setColor('mkt-ndx-chg', parseFloat(nChg)>=0?'var(--green-bright)':'var(--red-bright)');

  const fg = S.market.fearGreed;
  setText('mkt-fg', fg);
  setColor('mkt-fg', fg<30?'var(--red)':fg<50?'var(--orange)':'var(--green)');
  setText('mkt-fg-lbl', fg<25?'EXTREME FEAR':fg<40?'FEAR':fg<60?'NEUTRAL':'GREED');

  // Update card prices in-place
  for(const t of S.tickers) {
    const p = S.prices[t];
    if(!p?.price) continue;
    const priceEl = document.getElementById(`price-${t}`);
    if(priceEl) {
      const newText = '$'+p.price.toFixed(2);
      if(priceEl.textContent !== newText) {
        const prev = S.prevSnapshot[t] || p.price;
        priceEl.textContent = newText;
        if(p.price > prev) { priceEl.classList.add('tick-up'); setTimeout(()=>priceEl.classList.remove('tick-up'),800); }
        else if(p.price < prev) { priceEl.classList.add('tick-dn'); setTimeout(()=>priceEl.classList.remove('tick-dn'),800); }
      }
    }
    const chgEl = document.getElementById(`chg-${t}`);
    if(chgEl && p.prevClose) {
      const chg = ((p.price-p.prevClose)/p.prevClose*100);
      chgEl.textContent = (chg>=0?'+':'')+chg.toFixed(2)+'%';
      chgEl.className = 'mono day-chg '+(chg>=0?'up':'dn');
    }
  }

  // Status
  const dot = document.getElementById('status-dot');
  if(dot) dot.className = 'dot '+(S.wsConnected?'ws':S.lastPoll?'live':'off');
  const lbl = document.getElementById('status-label');
  if(lbl) lbl.textContent = S.wsConnected?'REAL-TIME (WS)':S.lastPoll?'FINNHUB REST':'CONNECTING...';
  const time = document.getElementById('status-time');
  if(time && S.lastPoll) time.textContent = S.lastPoll.toLocaleTimeString();
}

function setText(id, text) { const el=document.getElementById(id); if(el&&el.textContent!=text) el.textContent=text; }
function setColor(id, color) { const el=document.getElementById(id); if(el) el.style.color=color; }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SEARCH LISTENERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function attachSearchListeners() {
  const input = document.getElementById('search-input');
  const results = document.getElementById('search-results');
  if(!input || !results) return;

  input.addEventListener('input', () => {
    clearTimeout(searchTimeout);
    const q = input.value.trim();
    if(q.length < 1) { results.classList.remove('show'); return; }
    searchTimeout = setTimeout(async () => {
      const items = await searchTickers(q);
      if(items.length === 0) { results.classList.remove('show'); return; }
      results.innerHTML = items.slice(0,8).map(r => `
        <div class="search-item" onclick="addTicker('${r.symbol}');document.getElementById('search-input').value='';document.getElementById('search-results').classList.remove('show')">
          <div><span class="mono sym">${r.symbol}</span><div class="desc">${r.description}</div></div>
          <span class="mono type">${r.type}</span>
        </div>
      `).join('');
      results.classList.add('show');
    }, 300);
  });

  input.addEventListener('keydown', (e) => {
    if(e.key === 'Enter') {
      const q = input.value.trim().toUpperCase();
      if(q) { addTicker(q); input.value=''; results.classList.remove('show'); }
    }
  });

  document.addEventListener('click', (e) => {
    if(!e.target.closest('.search-container')) results.classList.remove('show');
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ACTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.switchTab = (tab) => { S.activeTab = tab; render(); updateUI(); };
window.selectTicker = (t) => { S.selected = t; render(); updateUI(); };
window.addTicker = addTicker;
window.removeTicker = removeTicker;
window.adjustWeight = adjustWeight;
window.pollAllQuotes = pollAllQuotes;
window.executeTrade = executeTrade;

window.quickBuy = (symbol) => {
  const price = S.prices[symbol]?.price;
  if(!price) { showToast('No price data','error'); return; }
  const shares = Math.floor(Math.min(S.portfolio.cash * 0.25, S.portfolio.cash) / price);
  if(shares < 1) { showToast('Insufficient cash','error'); return; }
  executeTrade(symbol, 'BUY', shares, price);
};

window.quickSell = (symbol) => {
  const pos = S.positions.find(p => p.symbol === symbol);
  if(!pos) { showToast('No position','error'); return; }
  const price = S.prices[symbol]?.price || pos.avgCost;
  executeTrade(symbol, 'SELL', pos.shares, price);
};

window.submitTrade = (type) => {
  const symbol = document.getElementById('trade-symbol')?.value?.trim()?.toUpperCase();
  const shares = parseInt(document.getElementById('trade-shares')?.value);
  let price = parseFloat(document.getElementById('trade-price')?.value);
  if(!symbol || !shares || shares < 1) { showToast('Enter symbol and shares','error'); return; }
  if(!price || isNaN(price)) price = S.prices[symbol]?.price;
  if(!price) { showToast('No price - enter manually','error'); return; }
  executeTrade(symbol, type, shares, price);
};

function showToast(msg, type='') {
  const existing = document.querySelector('.toast');
  if(existing) existing.remove();
  const div = document.createElement('div');
  div.className = `toast ${type}`;
  div.textContent = msg;
  document.body.appendChild(div);
  setTimeout(() => div.style.opacity = '0', 2500);
  setTimeout(() => div.remove(), 3000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BOOTSTRAP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function init() {
  // Load config from server
  try {
    const r = await fetch('/api/config', {signal:AbortSignal.timeout(3000)});
    if(r.ok) {
      const d = await r.json();
      CFG.fk = d.fk || '';
      CFG.sbUrl = d.sbUrl || '';
      CFG.sbKey = d.sbKey || '';
      if(CFG.fk) localStorage.setItem('finnhub_key', CFG.fk);
    }
  } catch(e) {}

  // Init Supabase
  if(CFG.sbUrl && CFG.sbKey) {
    sb = new SupabaseClient(CFG.sbUrl, CFG.sbKey);
  }

  // Initial render
  render();

  // Load watchlist from Supabase
  await loadWatchlist();
  await loadTrades();

  // If no tickers from DB, start empty (user searches)
  if(S.tickers.length > 0) S.selected = S.tickers[0];
  render();

  // Connect WS
  if(CFG.fk || localStorage.getItem('finnhub_key')) connectWS();

  // Initial data fetch
  await Promise.all([pollAllQuotes(), fetchFearGreed()]);
  render();
  updateUI();

  // Polling intervals
  setInterval(pollAllQuotes, POLL_MS);
  setInterval(fetchFearGreed, 300000);
  setInterval(saveSnapshot, SNAPSHOT_MS);
  setInterval(() => {
    S.countdown = Math.max(0, S.countdown - 1);
    setText('countdown', S.countdown);
  }, 1000);

  // Refresh trading tab periodically for live P&L
  setInterval(() => {
    if(S.activeTab === 'trading' && S.positions.length > 0) {
      render(); updateUI();
    }
  }, 30000);
}

init();
</script>
</body>
</html>
